{% extends "main.html" %}
{% block extra_head %}
{% endblock %}
{% block content %}
{% include "header.html" %}
<style>
  .collection a.collection-item{
    color: var(--blue-medium);
  }
  mark{
    background: transparent;
    color: red;
    font-weight: bold;
  }

</style>
  {% raw %}
    <main>
      <!-- Loading Screen -->
      <div id="loading-overlay" class="center-align" style="background-color: rgba(18, 52, 84, 0.5); cursor: default;">
        <div class="center-align" style="padding-top: 300px;">
          <object width="100px"  alt="Loading" data="/static/img/fly.gif" class=""></object>
          <h3 class="white-text logoFont">Loading...</h3>
        </div>
      </div>
    <div id="app" style="height: 100%;" class="white">
        <!-- <div class="side-nav" id="filters">
            <div class="row">
                <div class="col s12">
                    <h5>Tags</h5>
                    <div class="collection">
                        <a v-for="tag in tags" href="#!" class="collection-item blue-grey-text" :class="{ active: 'tag.active' }" @click.prevent="tag.active = !tag.active">
                         >{{tag.name}}&nbsp;({{tag.count}})
                        </a>
                    </div>
                </div>
            </div>
        </div> -->
        <div class="row full-height">
            <div class="col l2 s12 hide-on-med-and-down hide-on-small-only sidebar">
                <h5 style="padding-top:100px" class="blue-grey-text">Tags</h5>
                <div class="collection">
                    <a :disabled='tagsCloseable' v-for="tag in tags" href="#!" class="collection-item smallFont" :class="{ active: tag.active, blue: tag.active, 'white-text': tag.active }" @click.prevent="tag.active = !tag.active;search(query);">{{tag.name}}&nbsp;({{tag.count}})</a>
                </div>
            </div>
            <div class="col l10 s12 ">
                <div class="row">
                    <form class="col s12 center-align" @submit.prevent="search(query)" id="api_search_form">
                        <div class="input-field col s12 l6 offset-l3">
                            <i class="material-icons prefix grey-text">search</i>
                            <input aria-required="false" required='false' id="search_query" type="text" v-model="query" name="query" placeholder="Enter any query term here">
                            <label for="search_query"></label>
                        </div>
                        <div class="col s12 selected-tags">
                            <div class="chip" v-for="tag in tags" v-if="tag.active">
                                <i class="fa fa-tag blue-text" aria-hidden="true"></i>  {{tag.name}}
                                <i v-if='tagsCloseable' class="close material-icons" @click="tag.active = false;search(query)">close</i>
                            </div>
                        </div>
                        <div class="col s12">
                            <button type="submit" class="waves-effect waves-light blue btn">search</button>&nbsp;&nbsp;&nbsp;
                            <button class="waves-effect waves-light blue btn" v-on:click="clear_form()">clear</button>
                        </div>
                    </form>
                </div>
                <div class="row search-results">
                  <!-- Special Tags -->
                  <div v-if='specialUI' class="col s12">
                    <h1 class="blue-text logoFont tracking-in-expand">{{Tags}}</h1>
                  </div>
                  <!-- Special Tags -->
                    <div class="col s12">
                        <div>
                          Total APIs: <span class="blue-text">{{total}}</span>
                          <span style="float: right">Sorted <a id="sortName" @click.prevent="sortApisByName()" class="smallButton">A-Z</a></span>
                        </div>
                        <div class="card context" v-for="api in paginatedApis">
                            <div class="card-content ">
                                <span class="card-title">
                                  <span class="blue-text bold">
                                    {{api.info.title}}
                                  </span>
                                  <span class="versionBadge grey">
                                    V.{{api.info.version}}
                                  </span>
                                  <span v-if=" api.hasOwnProperty('openapi') " class="versionBadge green">
                                    OAS3
                                  </span>
                                  <span v-else-if=" api.hasOwnProperty('swagger') " class="versionBadge blue">
                                    Swagger2
                                  </span>
                                  <span v-if="userInfo && api._meta.github_username === userInfo.login " class="versionBadge orange darken-4">
                                    My API
                                  </span>
                                </span>
                                <br />
                                <br />
                                <p class="blue-grey-text flow-text" v-html="compiledMarkdown(api.info.description || '')"></p>
                                <hr style="border: dotted 1px #e8e8e8 !important;"/>
                                <div class="full-width">
                                  <a v-for="tag in api.tags" href="#!" @click.prevent="matchTagAndSearch(tag.name);" class="grey-text link" style="font-size: 12px; margin:3px; cursor: pointer;">
                                    <i class="fa fa-tag blue-text" aria-hidden="true"></i> {{tag.name}}
                                  </a>
                                </div>
                            </div>
                            <div class="card-action grey lighten-5">
                                <a class="green-text smallFont" href="#" @click.prevent=" ()=>{toggleDetails(api); showHideDetails($event);}">
                                   show details
                                </a>
                            </div>
                            <div class="card-content grey lighten-5" v-if="api.showDetails == true">
                                <strong>SmartAPI ID:</strong> <a v-bind:href='"/api/metadata/"+api._id'>{{api._id}}</a><br>
                                <strong>Metadata URL:</strong> <a v-bind:href='api._meta.url'>{{_.truncate(api._meta.url)}}</a><br>
                                <strong>Version:</strong> {{api.info.version}}<br>
                                <template v-if='api && api.info'>

                                  <strong>Developer:</strong> {{api.info.contact.name || api._meta.github_username }}<br>
                                </template>
                                <table class="bordered">
                                  <thead>
                                    <th class="center-align lighter">
                                      Operations
                                    </th>
                                    <th class="center-align lighter">
                                      Summary
                                    </th>
                                  </thead>
                                    <tr v-for="(summary, operation) in getOperations(api)">
                                      <td class="">
                                        <span :class="operationStyling(operation)">{{operation}}</span>
                                      </td>
                                      <td class="blue-grey-text">
                                        {{summary}}
                                      </td>
                                    </tr>
                                </table>
                                <br />
                                <a class="waves-effect waves-light btn  light-blue darken-4 smallFont"
                                   v-bind:href='"/ui/"+api._id' >
                                   View API Doc
                                </a>
                                <a class="waves-effect waves-light btn blue smallFont"
                                   v-bind:href='"/editor-oa3/?url=/api/metadata/"+api._id' target="_blank">
                                   Edit
                                </a>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col s12 m6 l6">
                                <ul class="pagination">
                                    <li class="waves-effect" :class="{ disabled: page <= 1 }">
                                        <a href="#" @click.prevent="prevPage()"><i class="material-icons">chevron_left</i> Previous</a>
                                    </li>

                                    <li class="waves-effect" :class="{ active: page == n, blue: page == n, 'white-text': page == n  }" v-for="n in pages">
                                        <a href="#" @click.prevent="page = n">{{n}}</a>
                                    </li>

                                    <li class="waves-effect" :class="{ disabled: page >= pages }">
                                        <a href="#" @click.prevent="nextPage()">Next <i class="material-icons">chevron_right</i></a>
                                    </li>
                                </ul>
                            </div>
                            <div class="col s12 m6 l6 right-align">
                                Per page:
                                <select class="perPage" v-model="perPage" @change="calculatePages" id="perPage">
                                    <option value="20">20</option>
                                    <option value="50">50</option>
                                    <option value="100">100</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
  </main>
    {% endraw %}
{% include "footer.html" %}
{% endblock %}


{% block extra_scripts %}
    <script src="https://cdnjs.cloudflare.com/ajax/libs/vue/2.4.2/vue.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/0.3.6/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/4.17.4/lodash.min.js"></script>
    <!-- Mark JS for search results highlighting -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/jquery.mark.min.js"></script>

    <script>
        var app = new Vue({
            el: '#app',
            data: function(){
              return {
                  total: 0,
                  apis: [],
                  tags:[],
                  query: '',
                  page: 1,
                  pages: 1,
                  perPage: 20,
                  keywords:'',
                  sortASC: true,
                  specialUI: false,
                  specialTags: [],
                  tagsCloseable : true,
                  userInfo: {}
              }
            },
            methods: {
                matchTagAndSearch: function(tagName){
                  var self = this;
                  for (var i = 0; i < self.tags.length; i++) {
                    if (self.tags[i].name === tagName) {
                      self.tags[i].active = true;
                      self.search(self.tags[i].name);
                    }
                    else{
                      self.search(tagName);
                    }
                  }
                },
                showHideDetails: function(event){
                  //toggle show/hide text on details link per card
                  let text = $(event.target).text().trim().toLowerCase();
                  if(text === 'show details'){
                    event.target.innerHTML = 'hide details';
                  }
                  else if(text === 'hide details'){
                    event.target.innerHTML = 'show details';
                  }
                },
                operationStyling: function(op){
                  //styles operations based on type
                  switch( op.substr(0,3) ){
                        case 'GET' :
                          return 'bold blue-text operation';
                          break;
                        case 'POS' :
                          return 'bold green-text operation';
                          break;
                        case 'PUT' :
                          return 'bold amber-text operation';
                          break;
                        case 'DEL' :
                            return 'bold red-text operation';
                            break;
                        case 'HEA' :
                            return 'bold deep-purple-text operation';
                            break;
                        case 'PAT' :
                            return 'bold brown-text operation';
                            break;
                        case 'PAR' :
                            return 'bold teal-text operation';
                            break;
                        default:
                           return 'bold gray-text operation'
                            break;
                  }
                },
                loading_start: function(){
                    $('#loading-overlay').show();
                },
                loading_end: function(){
                    $('#loading-overlay').hide();
                },
                getKeywords: function(){
                  var self= this;
                  // Read the keyword

                  self.keywords = $("input[name='query']").val();
                  self.mark();
                },
                mark: function(){
                  //unmark and mark current search
                  var self= this;
                  $(".context").unmark({
                    done: function() {
                      $(".context").mark(self.keywords);
                    }
                  });
                },
                refreshApis: function(){
                    var self = this;
                    // axios.get('/api/metadata/all?meta=1').then(function (response) {
                    //     self.apis = response.data;
                    var params = {
                        "params": {
                            "q": "__all__",
                        }
                    }
                    var filters = this.getQueryFilters();
                    if (filters)
                        params["params"]["filters"] = filters;
                    this.loading_start();
                    axios.get("/api/query?size=100", params).then(function(response){
                        self.loading_end();
                        //self.apis = response.data.hits;
                        self.apis = _.sortBy(response.data.hits,'info.title');
                        self.total = response.data.total;
                        self.calculatePages();
                    });
                },
                refreshTags: function (){
                    var self = this;
                    axios.get('/api/suggestion?field=tags.name').then(function(response){
                        self.tags = _.map(response.data.field_values.buckets, function(item){
                            return {'name':item.key, 'count': item.doc_count, 'active': false};
                        });
                    });
                },
                getQueryFilters: function(){
                    var filters = [];
                    this.tags.forEach(function(item){
                        if (item.active)
                            filters.push(item.name);
                    });
                    if (filters.length > 0)
                        filters = {'tags.name.raw': filters};
                        return filters;
                },
                clear_form: function(){
                    this.query = '';
                    this.refreshApis();
                },
                searchForTags: function(tagName){
                  var self = this;
                  for (var i = 0; i < self.tags.length; i++) {
                    if (self.tags[i].name === tagName) {
                      self.tags[i].active = !self.tags[i].active;
                      self.search();
                    }
                    else{
                      self.search();
                    }
                  }
                },
                search: function (query) {
                    var self = this;
                    if (!query)
                        query = $('#search_query').val();
                      query = query || "__all__";
                    if (query) {
                        var params = {
                            "params": {
                                "q": query,
                            }
                        };
                        var filters = this.getQueryFilters();
                        if (filters)
                            params["params"]["filters"] = filters;
                        this.loading_start();
                        $(".context").unmark();
                        axios.get('/api/query?size=100', params).then(function (response) {
                            self.loading_end();
                            $(".context").unmark();
                            self.apis = response.data.hits;
                            //console.log(self.apis);
                            self.total = response.data.total;

                            self.calculatePages();
                        });
                    }
                },
                calculatePages: function () {
                    this.pages = Math.ceil(this.apis && this.apis.length / this.perPage);
                },
                prevPage: function () {
                    if (this.page > 1)
                        this.page -= 1
                },
                nextPage: function () {
                    if (this.page < this.pages)
                        this.page += 1
                },
                compiledMarkdown: function (mdtext) {
                    return marked(mdtext, { sanitize: true })
                },
                toggleDetails: function (api) {
                    this.$set(api, 'showDetails', !api.showDetails);
                },
                getOperations: function (api, raw=false) {
                    var operations = {};
                    if (raw) {
                        for(var path in api.paths) {
                            for(var method in api.paths[path]) {
                                operations[[method.toUpperCase(), path].join(' ')] = api.paths[path][method].summary;
                            }
                        }
                    }else{
                        api.paths.forEach(function(path){
                            for(var method in path['pathitem']) {
                                operations[[method.toUpperCase(), path.path].join(' ')] = path['pathitem'][method].summary;
                            }
                        })
                    }
                    return operations;
                },
                sortApisByName: function(){
                  var self = this;
                  $(".context").unmark();
                  self.sortASC = !self.sortASC;
                },
                getUserInfo: function(){
                  var self= this;
                  axios.get('/user').then(response=>{
                    self.userInfo = response.data;
                  }).catch(err=>{
                    throw err;
                  })
                },
                handleSpecialTags: function(sTag){
                  var self = this;
                  self.specialUI = true;
                  for (var i = 0; i < self.tags.length; i++) {
                    for (var x = 0; x < rTags.length; x++) {
                      if (self.tags[i] === rTags[x]) {
                        self.tags[i].active = true;
                        self.tagsCloseable = false;
                      }
                    }
                  }
                },
                handleRegularTags: function(rTags){
                  var self = this;
                  for (var i = 0; i < self.tags.length; i++) {
                    for (var x = 0; x < rTags.length; x++) {
                      if (self.tags[i] === rTags[x]) {
                        self.tags[i].active = true;
                        self.tagsCloseable = false;
                      }
                    }
                  }
                }
            },
            created: function () {
                this.getUserInfo();
                $(".button-collapse").sideNav();
                this.refreshApis();
                this.refreshTags();
                // if( {{Special}} === 'true' ){
                //   this.handleSpecialTags({{Tags}});
                // }
                // else if ({{Special}} === 'false' && {{Tags}}.length) {
                //   this.handleRegularTags({{Tags}});
                // }
            },
            updated: function(){
              // Highlight matches in results
              this.getKeywords();
            },
            computed: {
                paginatedApis: function () {
                    var start = (this.page - 1) * this.perPage,
                        end = start + this.perPage;
                    return this.apis && this.apis.slice(start, end);
                }
            },
            watch:{
              sortASC: function(sort){
                var self = this;
                if (!sort) {
                  self.apis = _.sortBy(self.apis,'info.title');
                  $("#sortName").text('A-Z');
                }else if (sort){
                  self.apis = _.sortBy(self.apis,'info.title').reverse();
                  $("#sortName").text('Z-A');
                }
              }
            }
        });
    </script>
{% endblock %}
