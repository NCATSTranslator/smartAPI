{% extends "main.html" %}
{% block extra_head %}
{% endblock %}
{% block content %}
{% include "header.html" %}
<style>
/* Test CSS */
.apiStatus{
  float: right;
}
</style>
  {% raw %}
    <main>
      <!-- Loading Screen -->
      <div id="loading-overlay" class="center-align" style="background-color: rgba(18, 52, 84, 0.5); cursor: default;">
        <div class="center-align" style="padding-top: 300px;">
          <object width="100px"  alt="Loading" data="/static/img/fly.gif" class=""></object>
          <h3 class="white-text logoFont">Loading...</h3>
        </div>
      </div>
    <div id="app" style="height: 100%;" class="white">
        <div class="row full-height">
            <div class="col l2 s12 hide-on-med-and-down hide-on-small-only sidebar">
                <h5 style="padding-top:100px" class="blue-grey-text"><i class="fa fa-filter" aria-hidden="true"></i> Filters</h5>
                <ul class="collapsible">
                  <li>
                    <div class="collapsible-header blue-grey lighten-5 blue-grey-text smallFont"><i class="fa fa-tag" aria-hidden="true"></i> By Tags</div>
                    <div class="collapsible-body noPadding">
                      <div class="collection">
                          <a :class="{ disable: tag.name.toLowerCase() === specialTagOriginalName.toLowerCase(), active: tag.active, blue: tag.active  && tag.name.toLowerCase() !== specialTagOriginalName.toLowerCase(), green: tag.active  && tag.name.toLowerCase() === specialTagOriginalName.toLowerCase() , 'white-text': tag.active}" v-for="tag in tags" href="#!" class="collection-item smallFont" @click.prevent="tag.active = !tag.active;search(query); googleAnalytics('Registry_Tag', tag.name)">{{tag.name}}  <span class="bold">({{tag.count}})</span></a>
                      </div>
                    </div>
                  </li>
                  <li>
                    <div class="collapsible-header blue-grey lighten-5 blue-grey-text smallFont"><i class="fa fa-user" aria-hidden="true"></i> By Owners</div>
                    <div class="collapsible-body noPadding">
                      <div class="collection">
                          <a :class="{ active: author.active, blue: author.active }" v-for="author in authors" href="#!" class="collection-item smallFont " @click.prevent="author.active = !author.active;search(query); googleAnalytics('Registry_Author', author.name)">{{author.name}}  <span class="bold">({{author.count}})</span> <span class="red-text" v-if="userInfo && author.name === userInfo.name">(Me)</span></a>
                      </div>
                    </div>
                  </li>
                </ul>
            </div>
            <div class="col l10 s12 ">
                <div class="row">
                    <form class="col s12 center-align" @submit.prevent="search(query)" id="api_search_form">
                      <template v-if='specialTagsUI'>
                        <div  class="col s12 l3 input-field center-align">
                          <a class='tooltipped' data-position="bottom" :data-tooltip="'Learn More about '+specialTagName" :href="specialTagURL" target="_blank" style="cursor: pointer !important;">
                            <img v-if="specialTagsUI" width="auto" style="max-height: 40px; max-width:100%;" height="auto" :src="specialTagImage"  :alt="specialTagName"/>
                          </a>
                        </div>
                        <div class="input-field col s12 l6">
                            <input aria-required="false" required='false' id="search_query" type="text" v-model="query" name="query" placeholder="Enter any query term here" class="browser-default margin20 grey lighten-5 blue-grey-text lighter" style="width: 50%; outline: none; padding: 10px; border-radius: 20px; border:var(--blue-medium) 2px solid;">
                            <input style="width:5px; opacity:0 !important;"  class="swatch" style="background-color: #E4F2FC;" id="shareButton" :value="shareURL">
                            </input>
                            <button @click.prevent="googleAnalytics('Registry_SharedURL', window.location.href ); copyConf()" v-if="shareURLButtonVisible" style="cursor: pointer;" class="smallButton tooltip grey lighten-2 grey-text copyBtn scale-in-center" data-clipboard-target="#shareButton">
                              Share Search
                              <span class="tooltiptext">Click to copy search URL</span>
                            </button>
                        </div>
                      </template>
                      <template v-else>
                        <div class="input-field col s12 l6 offset-l3">
                            <input aria-required="false" required='false' id="search_query" type="text" v-model="query" name="query" placeholder="Enter any query term here" class="browser-default margin20 grey lighten-5 blue-grey-text lighter" style="width: 50%; outline: none; padding: 10px; border-radius: 20px; border:var(--blue-medium) 2px solid;">
                            <input style="width:5px; opacity:0 !important;"  class="swatch" style="background-color: #E4F2FC;" id="shareButton" :value="shareURL">
                            </input>
                            <button @click.prevent="googleAnalytics('Registry_SharedURL', window.location.href); copyConf()" v-if="shareURLButtonVisible" style="cursor: pointer;" class="smallButton tooltip grey lighten-2 grey-text copyBtn scale-in-center" data-clipboard-target="#shareButton" >
                              Share Search
                              <span class="tooltiptext">Click to copy search URL</span>
                            </button>
                        </div>
                      </template>

                        <div class="col s12 selected-tags">
                            <div class="chip scale-in-center" v-for="tag in tags" v-if="tag.active" :class="{ green: tag.name.toLowerCase() === specialTagOriginalName.toLowerCase(), 'white-text': tag.name.toLowerCase() === specialTagOriginalName.toLowerCase() }">
                                <i class="fa fa-tag" aria-hidden="true"></i>  {{tag.name}}
                                <i v-if="tag.name.toLowerCase() !== specialTagOriginalName.toLowerCase()" class="close material-icons" @click="tag.active = false;search(query)">close</i>
                            </div>
                            <div class="chip scale-in-center" v-for="author in authors" v-if="author.active">
                                <i class="fa fa-user" aria-hidden="true"></i>  {{author.name}}
                                <i class="close material-icons" @click="author.active = false;search(query)">close</i>
                            </div>
                        </div>
                        <div class="col s12">
                            <button type="submit" @click="googleAnalytics('Registry_Searches',query)" class="waves-effect waves-light blue btn">search</button>&nbsp;&nbsp;&nbsp;
                            <a class="blue btn" href="/registry">clear</a>
                        </div>
                    </form>
                </div>
                <div class="row search-results">
                    <div class="col s12">
                        <div class="blue-grey-text">
                           <div class="row">
                             <div class="col s5 m10">
                               Total APIs: <span class="blue-text">{{total}}</span>
                             </div>
                             <div class="col s5 m2">
                               <select class="browser-default" @change='sortResults($event)'>
                                 <option value="" disabled selected>Sort By</option>
                                 <option value="Search Relevance">Relevance</option>
                                 <option value="Alpabethically A-Z">Alpabethically A-Z</option>
                                 <option value="Alpabethically Z-A">Alpabethically Z-A</option>
                                 <option value="Recently Updated">Recently Updated</option>
                               </select>
                             </div>
                           </div>
                        </div>
                        <template v-if="total === 0">
                          <div class="card">
                            <div class="card-content center">
                              <i class="fa fa-exclamation-circle fa-2x grey-text" aria-hidden="true"></i>
                              <h5 class="grey-text">Your Search Returned No Results</h5>
                            </div>
                          </div>
                        </template>
                        <div class="card context scale-in-center" v-for="(api,index) in paginatedApis">
                            <div class="card-content ">
                                <span class="card-title">
                                  <span class="blue-grey-text bold">
                                    {{api.info.title}}
                                  </span>
                                  <span class="versionBadge grey">
                                    V.{{api.info.version}}
                                  </span>
                                  <span v-if=" api.hasOwnProperty('openapi') " class="versionBadge green">
                                    OAS3
                                  </span>
                                  <span v-else-if=" api.hasOwnProperty('swagger') " class="versionBadge blue">
                                    Swagger2
                                  </span>
                                  <a style="cursor: pointer !important;" href="/dashboard" v-if="userInfo && api._meta.github_username === userInfo.login " class="versionBadge orange darken-4">
                                    My&nbsp;API
                                  </a>
                                  <!-- <small class="apiStatus">
                                    Status <span>PASS</span>
                                  </small> -->
                                </span>
                                <template v-if="api.info.description && api.info.description.length > 500">
                                  <description :text='api.info.description'></description>
                                </template>
                                <template v-else>
                                  <div class="blue-grey-text flow-text" v-html="compiledMarkdown(api.info.description || '')"></div>
                                </template>
                                <hr style="border: dotted 1px #e8e8e8 !important;"/>
                                <div class="full-width">
                                  <a v-for="tag in api.tags" href="#!" @click.prevent="matchTagAndSearch(tag.name);search(query);" class="grey-text link" style="font-size: 12px; margin:3px; cursor: pointer;">
                                    <i class="fa fa-tag" aria-hidden="true"></i> {{tag.name}}
                                  </a>
                                </div>
                            </div>
                            <div class="card-action grey lighten-3" v-if="apis.length > 1">
                                <a style="border-radius: 20px;" class="btn blue white-text smallFont" href="#" @click.prevent="api.showDetails = !api.showDetails; googleAnalytics('Registry_APIs',api.info.title)">
                                  <template v-if="!api.showDetails">
                                    SHOW DETAILS
                                  </template>
                                  <template v-else>
                                    HIDE DETAILS
                                  </template>
                                </a>
                            </div>
                            <div class="card-content blue-grey lighten-5" v-if="api.showDetails || apis.length === 1">
                                <div class="row">
                                  <table class="pillTable">
                                    <tbody>
                                      <tr class="tablePillRow">
                                        <td class="grey white-text center">
                                          Registry URL
                                        </td>
                                        <td class="white blue-grey-text center" >
                                          <a class="link" target="_blank" v-bind:href='"?q="+api._id'>
                                            <span :id="'url'+api._id" :value="api._id">http://smart-api.info/registry?q={{api._id}}</span>
                                          </a>
                                          <button style="margin-left:10px;" class="smallButton copyBtn tooltip" :data-clipboard-target="'#url'+api._id">
                                            Copy
                                            <span class="tooltiptext">Click to copy this API's registry URL</span>
                                          </button>
                                        </td>
                                      </tr>
                                      <tr class="tablePillRow">
                                        <td class="grey white-text center">
                                          SmartAPI ID
                                        </td>
                                        <td class="white blue-grey-text center" >
                                          <a class="link tooltip" target="_blank" v-bind:href='"/api/metadata/"+api._id'>
                                            <span :id="'id'+api._id" :value="api._id">{{api._id}}</span> <i class="fa fa-external-link" aria-hidden="true"></i>
                                            <span class="tooltiptext"><small>Collected SmartAPI metadata</small></span>
                                          </a>
                                          <button style="margin-left:10px;" class="smallButton copyBtn tooltip" :data-clipboard-target="'#id'+api._id">
                                            Copy
                                            <span class="tooltiptext">Click to copy SmartAPI ID</span>
                                          </button>
                                        </td>
                                      </tr>
                                      <tr class="tablePillRow">
                                        <td class="grey white-text">
                                          Metadata URL
                                        </td>
                                        <td class="white blue-grey-text center">
                                          <a class="link tooltip" target="_blank" v-bind:href='api._meta.url'>
                                            {{_.truncate(api._meta.url)}} <i class="fa fa-external-link" aria-hidden="true"></i>
                                            <span class="tooltiptext"><small>Original API metadata</small></span>
                                          </a>
                                        </td>
                                      </tr>
                                      <tr class="tablePillRow">
                                        <td class="grey white-text">
                                          Version
                                        </td>
                                        <td class="white blue-grey-text center">
                                          V {{api.info.version}}
                                        </td>
                                      </tr>
                                      <template v-for='name in checkForName(api)'>
                                        <tr v-if="name != 'Name Unavailable'" class="tablePillRow">
                                          <td class="grey white-text">
                                            Contact
                                          </td>
                                          <td class="white blue-grey-text center">
                                            <i class="fa fa-user" aria-hidden="true"></i> {{ name }}
                                          </td>
                                        </tr>
                                      </template>
                                      <tr v-if="api._meta.slug" class="tablePillRow">
                                        <td class="grey white-text">
                                          Registered Slug
                                        </td>
                                        <td class="white blue-grey-text" >
                                           <b class="green-text">{{api._meta.slug}}</b> &gt; <a class="tooltip"  v-bind:href="'http://'+api._meta.slug+'.smart-api.info'" target="_blank">
                                             http://{{api._meta.slug}}.smart-api.info
                                             <span class="tooltiptext">
                                               <small>You can register a slug to share your docs in the user dashboard</small>
                                             </span>
                                           </a>
                                        </td>
                                      </tr>
                                      <tr class="tablePillRow">
                                        <td class="grey white-text center">
                                          Last Updated
                                        </td>
                                        <td class="white blue-grey-text center" :id="'id'+api._id" :value="api._id">
                                          {{ getDate(api._meta.timestamp) }}
                                        </td>
                                      </tr>
                                      <tr class="tablePillRow">
                                        <td colspan="2">
                                          <a class="btn green smallFont scale-in-center"
                                             v-bind:href='"/ui/"+api._id' >
                                             View API Documentation
                                          </a>
                                          <a class="btn blue smallFont scale-in-center"
                                             v-bind:href='"/editor/"+api._id'>
                                             Edit <i class="fa fa-pencil" aria-hidden="true"></i>
                                          </a>
                                        </td>
                                      </tr>
                                    </tbody>
                                  </table>
                                </div>
                                <h4 class="center grey-text">Operations</h4>
                                <table v-if=" api.hasOwnProperty('openapi') " class="bordered grey lighten-5" style="margin: 20px 0px;">
                                  <col width="30%">
                                  <col width="70%">
                                    <tr v-for="operation in getOperations(api)">
                                      <td style="white-space: pre-wrap; word-break: break-word;">
                                        <span class="versionBadge" :class="operationStyling(operation.method)">{{operation.method}}</span><span class="blue-text bold">{{operation.path}}</span>
                                      </td>
                                      <td class="blue-grey-text">
                                        {{operation.summary}}
                                      </td>
                                    </tr>
                                </table>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col s12 m6 l6">
                                <ul class="pagination">
                                    <li :class="{ disabled: page <= 1 }">
                                        <a href="#" @click.prevent="prevPage()"><i class="material-icons">chevron_left</i> Previous</a>
                                    </li>
                                    <li :class="{ active: page == n, blue: page == n, 'white-text': page == n  }" v-for="n in pages">
                                        <a href="#" @click.prevent="page = n">{{n}}</a>
                                    </li>
                                    <li :class="{ disabled: page >= pages }">
                                        <a href="#" @click.prevent="nextPage()">Next <i class="material-icons">chevron_right</i></a>
                                    </li>
                                </ul>
                            </div>
                            <div class="col s12 m6 l6 right-align">
                                Per page:
                                <select class="perPage" v-model="perPage" @change="calculatePages" id="perPage">
                                    <option value="20">20</option>
                                    <option value="50">50</option>
                                    <option value="100">100</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
  </main>
    {% endraw %}
{% include "footer.html" %}
{% endblock %}


{% block extra_scripts %}
    <script src="https://cdnjs.cloudflare.com/ajax/libs/vue/2.4.2/vue.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/0.3.6/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/4.17.4/lodash.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/jquery.mark.min.js"></script>
    <script src="/static/js/clipboard.js"></script>
    <script src="/static/js/moment.js"></script>
    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-129986551-1"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

        new ClipboardJS('.copyBtn');
            ClipboardJS.isSupported();

            Vue.component('description', {
              data: function(){
                return{
                  result:null,
                  fullTXT:false
                }
              },
              props: ['text'],
              methods:{
                compileMDWN: function(mdtext){
                  this.result = marked(mdtext, { sanitize: true });
                  return this.result;
                }
              },
              mounted: function(){
                this.compileMDWN(this.text)
              },
              template: `<div>
                          <div class="expandContainer" v-bind:class="{'max-height-none' : fullTXT, 'max-height-200': !fullTXT}">

                            <div class="center">

                              <a class="btn grey lighten-1 expandButtonLess" v-if="fullTXT" @click.prevent="fullTXT = !fullTXT;">
                                Collapse
                              </a>
                            </div>

                            <div class="blue-grey-text flow-text" v-html="result"></div>

                            <div class="center">
                              <a class="btn grey lighten-1 expandButtonLess" v-if="fullTXT" @click.prevent="fullTXT = !fullTXT;">
                                Collapse
                              </a>
                            </div>

                            <div v-if="!fullTXT" class="whiteFadeBox center">
                              <a class="btn grey lighten-1 expandButtonMore" v-if="!fullTXT" @click.prevent="fullTXT = !fullTXT;">Click to expand</a>
                            </div>
                          </div>
                        </div>`
            })

        var app = new Vue({
            el: '#app',
            data: function(){
              return {
                  total: 0,
                  apis: [],
                  tags:[],
                  query: '',
                  page: 1,
                  pages: 1,
                  perPage: 20,
                  keywords:'',
                  specialTagsUI: false,
                  specialTagName: '',
                  specialTagImage: '',
                  specialTagURL: '',
                  specialTagOriginalName: '',
                  userInfo: {},
                  context:{},
                  authors: [],
                  shareURL:'',
                  shareURLButtonVisible: false,
                  sort: 'Relevance'
              }
            },
            methods: {
                copyConf(){
                  const Toast = Swal.mixin({
                    toast: true,
                    position: 'top-end',
                    showConfirmButton: false,
                    timer: 3000
                  });
                  Toast.fire({
                    type: 'success',
                    title: 'Copied to Clipboard'
                  })
                },
                googleAnalytics(category, label){
                  // ga('send', 'event', [eventCategory], [eventAction], [eventLabel], [eventValue], [fieldsObject]);
                  ga('send', 'event', category, 'click', label);

                },
                sortResults(e){
                  console.log(e.target.value)
                  this.sort = e.target.value;
                },
                getDate(timestamp){
                  var date = moment(timestamp).format("LL");
                  return date;
                },
                handleDescriptionClick(event, show){
                  if (show) {
                    event.target.style.maxHeight = 'none';
                    if (event.target.children[1]) {
                      event.target.children[1].hidden = true;
                    }
                  }else{
                    event.target.style.maxHeight = '200px';
                    if (event.target.children[1]) {
                      event.target.children[1].hidden = false;
                    }
                  }
                },
                matchTagAndSearch: function(tagName){
                  var self = this;
                  for (var i = 0; i < self.tags.length; i++) {
                    if (self.tags[i].name === tagName) {
                      self.tags[i].active = true;
                      self.search(self.tags[i].name);
                    }
                  }
                },
                checkForName: function(api){
                  if (_.get(api, 'info.contact.name')) {
                    return [api.info.contact.name];
                  }
                  else{
                    return ['Name Unavailable'];
                  }
                },
                showHideDetails: function(event){
                  //toggle show/hide text on details link per card
                  let text = $(event.target).text().trim().toLowerCase();
                  if(text === 'show details'){
                    event.target.innerHTML = 'hide details';
                  }
                  else if(text === 'hide details'){
                    event.target.innerHTML = 'show details';
                  }
                },
                operationStyling: function(op){
                  //styles operations based on type
                  switch( op.substr(0,3) ){
                        case 'GET' :
                          return 'bold light-blue darken-1 white-text operation';
                          break;
                        case 'POS' :
                          return 'bold light-green white-text operation';
                          break;
                        case 'PUT' :
                          return 'bold amber lighten-2 white-text operation';
                          break;
                        case 'DEL' :
                            return 'bold deep-orange darken-1 white-text operation';
                            break;
                        case 'HEA' :
                            return 'bold deep-purple lighten-1 white-text operation';
                            break;
                        case 'PAT' :
                            return 'bold brown lighten-1 white-text operation';
                            break;
                        case 'PAR' :
                            return 'bold teal lighten-1 white-text operation';
                            break;
                        default:
                           return 'bold gray lighten-1 white-text operation'
                            break;
                  }
                },
                loading_start: function(){
                    $('#loading-overlay').show();
                },
                loading_end: function(){
                    $('#loading-overlay').hide();
                },
                getKeywords: function(){
                  var self= this;
                  // Read the keyword
                  self.keywords = $("input[name='query']").val();
                  self.mark(self.keywords);
                },
                mark: function(kw){
                  //unmark and mark current search
                  var self= this;
                  $(".context").unmark({
                    done: function() {
                      $(".context").mark(kw);
                    }
                  });
                },
                refreshApis: function(){
                    var self = this;
                    self.handleContext(self.context);
                    //check for existing query in url string
                    self.checkforQuery();
                    let query = self.query;
                    if(!self.query){
                      query="__all__"
                    }
                    var params = {
                        "params": {
                            "q": encodeURIComponent(query),
                            // 'fields': 'info,_meta,paths,tags,openapi,swagger,'
                            'fields': 'info,_meta,paths.path, paths.pathitem.get.summary,paths.pathitem.post.summary,paths.pathitem.delete.summary,paths.pathitem.patch.summary,paths.pathitem.put.summary,paths.pathitem.head.summary,paths.pathitem.put.summary,options.pathitem.head.summary,paths.pathitem.put.summary,paths.pathitem.trace.summary, tags,openapi,swagger,'
                        }
                    }
                    var filters = self.getQueryFilters();
                    if (filters)
                        params["params"]["filters"] = filters;
                    self.loading_start();
                    axios.get("/api/query?size=100", params).then(function(response){
                        self.loading_end();
                        // console.log(response.data.hits);
                        self.apis = response.data.hits;
                        self.total = response.data.total;
                        self.calculatePages();
                    }).catch(err=>{
                      throw err;
                      self.loading_end();
                    });
                },
                loadFilters: function (){
                    var self = this;
                    axios.get('/api/suggestion?field=tags.name').then(function(response){
                        self.tags = _.map(response.data.field_values.buckets, function(item){
                            return {'name':item.key, 'count': item.doc_count, 'active': false};
                        });
                        axios.get('/api/suggestion?field=info.contact.name').then(function(response){
                            self.authors = _.map(response.data.field_values.buckets, function(item){
                                return {'name':item.key, 'count': item.doc_count, 'active': false};
                            });
                            //When all filters all loaded
                            //share url params depend on filters being loaded
                            self.refreshApis();
                        });

                    });
                },
                getQueryFilters: function(){
                    var filters = [];
                    var authorFilters = [];
                    var finalFilters = {};
                    this.tags.forEach(function(item){
                      if (item.active)
                          filters.push(item.name);
                      });
                    if (filters.length > 0){
                      finalFilters['tags.name.raw'] = filters;
                    }

                    this.authors.forEach(function(item){
                      if (item.active){
                        authorFilters.push(item.name);
                      }
                      });
                    if (authorFilters.length){
                      finalFilters['info.contact.name.raw'] = authorFilters;
                    }

                    return finalFilters;
                },
                searchForTags: function(tagName){
                  var self = this;
                  for (var i = 0; i < self.tags.length; i++) {
                    if (self.tags[i].name === tagName) {
                      self.tags[i].active = !self.tags[i].active;
                      self.search();
                    }
                    else{
                      self.search();
                    }
                  }
                },
                buildShareURL: function(q){
                  var filters = [];
                  var authorFilters = [];
                  var finalFilters = '';
                  var finalAuthorFilters ='';
                  var finalURL = window.location.origin+window.location.pathname;
                  // Collect TAGS
                  this.tags.forEach(function(item){
                    if (item.active)
                        filters.push(item.name);
                    });
                  // Collect Owners
                  this.authors.forEach(function(item){
                    if (item.active){
                      authorFilters.push(item.name);
                    }
                  });
                  //Detect QUERY
                  if (q !== '__all__') {
                    finalURL = finalURL+'?q='+q;
                    //if any tags are actuve
                    if(authorFilters.length || filters.length){
                      finalURL = finalURL+"&";
                    }
                  }
                  //if tags active but no query
                  else if(authorFilters.length || filters.length){
                    finalURL = finalURL+"?";
                  }
                  // if BOTH filters exists
                  if (filters.length && authorFilters.length) {
                    finalFilters = filters.join(',')
                    finalURL = finalURL+"tags="+finalFilters;

                    finalAuthorFilters = authorFilters.join(',')
                    finalURL = finalURL+"&owners="+finalAuthorFilters;
                  }
                  // if Owners Exist but no Tags
                  else if (!filters.length && authorFilters.length) {
                    finalAuthorFilters = authorFilters.join(',')
                    finalURL = finalURL+"owners="+finalAuthorFilters;
                  }
                  // if Tags exists but no owners
                  else if (filters.length && !authorFilters.length) {
                    finalFilters = filters.join(',')
                    finalURL = finalURL+"tags="+finalFilters;
                  }

                  this.shareURL =finalURL;
                  //HTML5 change url history
                  window.history.pushState({"html":'content',"pageTitle":'SmartAPI'},"", finalURL);
                  this.shareURLButtonVisible = true;
                },
                search: function (query) {
                    var self = this;
                    self.context= {{Context}};
                    if (!self.context.Special && !query){
                      query = $('#search_query').val();
                      query = query || "__all__";
                    }
                    else if (self.context.Special && !query) {
                      query = query || "__all__";
                      self.handleSpecialTags(self.context.Tags[0]);
                    }
                    if (query) {
                        var params = {
                            "params": {
                                "q": encodeURIComponent(query),
                                // 'fields': 'info,_meta,paths,tags,openapi,swagger'
                                'fields': 'info,_meta,paths.path, paths.pathitem.get.summary,paths.pathitem.post.summary,paths.pathitem.delete.summary,paths.pathitem.patch.summary,paths.pathitem.put.summary,paths.pathitem.head.summary,paths.pathitem.put.summary,options.pathitem.head.summary,paths.pathitem.put.summary,paths.pathitem.trace.summary, tags,openapi,swagger,'

                            }
                        };
                        var filters = this.getQueryFilters();
                        if (filters)
                            params["params"]["filters"] = filters;
                        this.loading_start();
                        // Share search URL
                        self.buildShareURL(query);

                        $(".context").unmark();
                        axios.get('/api/query?size=100', params).then(function (response) {
                            self.loading_end();
                            $(".context").unmark();
                            self.apis = response.data.hits;
                            self.handleContext(self.context);
                            self.total = response.data.total;
                            self.page = 1;
                            self.calculatePages();
                        }).catch(err=>{
                          throw err;
                          self.loading_end();

                        });
                    }
                },
                calculatePages: function () {
                    this.pages = Math.ceil(this.apis && this.apis.length / this.perPage);
                },
                prevPage: function () {
                    if (this.page > 1)
                        this.page -= 1
                },
                nextPage: function () {
                    if (this.page < this.pages)
                        this.page += 1
                },
                compiledMarkdown: function (mdtext) {
                    return marked(mdtext, { sanitize: true })
                },
                toggleDetails: function (api) {
                  this.$set(api, 'showDetails', !api.showDetails);
                },
                validateFields(path){
                  let paths = ['GET','POST','PUT','DELETE','PATCH','TRACE','HEAD','CONNECT'];
                  if (paths.includes(path)) {
                    return path;
                  }else if (path === "PARAMETERS") {
                      return 'GET';
                  }
                },
                getOperations: function (api, raw=false) {
                  var self= this;
                    var operations = [];
                    if (raw) {
                        for(var path in api.paths) {
                            for(var method in api.paths[path]) {
                                operations.push({'method': self.validateFields(method.toUpperCase()), 'summary': path['pathitem'][method].summary, 'path': path })
                            }
                        }
                    }else{
                        api.paths.forEach(function(path){
                            for(var method in path['pathitem']) {
                                operations.push({'method': self.validateFields(method.toUpperCase()), 'summary': path['pathitem'][method].summary, 'path': path.path })
                            }
                        })
                    }
                    return operations;
                },
                getUserInfo: function(){
                  var self= this;
                  axios.get('/user').then(response=>{
                    self.userInfo = response.data;
                  }).catch(err=>{
                    throw err;
                  })
                },
                handleRegularTags: function(rTags){
                  var self = this;
                    self.specialUI = false;
                    for (var i = 0; i < rTags.length; i++) {
                      for (var x = 0; x < self.tags.length; x++) {
                        if (rTags[i].toLowerCase() === self.tags[x].name.toLowerCase()) {
                          self.tags[x].active = true;
                        }
                      }
                    }
                },
                handleOwnerTags: function(rTags){
                  var self = this;
                    self.specialUI = false;
                    for (var i = 0; i < rTags.length; i++) {
                      for (var x = 0; x < self.authors.length; x++) {
                        if (rTags[i].toLowerCase() === self.authors[x].name.toLowerCase()) {
                          self.authors[x].active = true;
                        }
                      }
                    }
                },
                handleContext: function(context){
                  // console.log(context);
                  if (context.Special) {
                    this.handleSpecialTags(this.context.Tags[0]);
                  }
                  if (!context.Special && !_.isEmpty(context.Tags)) {
                    this.handleRegularTags(this.context.Tags);
                  }
                  if (!context.Special &&  !_.isEmpty(context.Owners)) {
                    this.handleOwnerTags(this.context.Owners);
                  }
                },
                handleSpecialTags: function(tagname){
                  var self = this;
                    self.specialTagsUI = true;
                    self.specialTagOriginalName = tagname.toUpperCase();
                    switch (tagname) {
                      case 'translator':
                        self.specialTagName = 'NCATS Biomedical Data Translator';
                        self.specialTagImage = '/static/img/ncats-logo.png';
                        self.specialTagURL = 'https://ncats.nih.gov/translator';
                        break;
                        case 'nihdatacommons' || 'NIHdatacommons':
                          self.specialTagName = 'NIH Data Commons';
                          self.specialTagImage = '/static/img/nih-logo.png';
                          self.specialTagURL = 'https://commonfund.nih.gov/commons';
                          break;
                      default:
                        self.specialTagName = tagname.toUpperCase();
                        self.specialTagImage = '/static/img/logo-small.png';
                        self.specialTagURL = 'https://smart-api.info';
                    }
                    for (var i = 0; i < self.tags.length; i++) {
                      if (self.tags[i].name.toLowerCase() === tagname.toLowerCase()) {
                        self.tags[i].active = true;
                      }
                    }
                },
                checkforQuery: function(){
                  var url_string = window.location.href
                  var url = new URL(url_string);
                  var q = url.searchParams.get("q");
                  if (q) {
                    this.query = q;
                  }
                }
            },
            created: function () {
                this.getUserInfo();
                $(".button-collapse").sideNav();
                $('.collapsible').collapsible();
                this.loadFilters();
                this.context = {{Context}};

            },
            updated: function(){
              // Highlight matches in results
              this.getKeywords();
            },
            computed: {
                paginatedApis: function () {
                    var start = (this.page - 1) * this.perPage,
                        end = start + this.perPage;
                    return this.apis && this.apis.slice(start, end);
                }
            },
            watch:{
              sort: function(sort){
                var self = this;
                switch (sort) {
                  case 'Alpabethically A-Z':
                  self.apis = _.sortBy(self.apis,'info.title');
                    break;
                  case 'Alpabethically Z-A':
                  self.apis = _.sortBy(self.apis,'info.title').reverse();
                  break;
                  case 'Recently Updated':
                  self.apis = _.sortBy(self.apis,'._meta.timestamp').reverse();
                  break;
                  case 'Search Relevance':
                  self.search();
                  break;
                  default:
                  self.apis = _.sortBy(self.apis,'info.title');
                }
              },
              apis: function(apis,oldapis){
                var self = this;
                for (var i = 0; i < apis.length; i++) {
                  self.$set(apis[i], 'showDetails', false);
                }
              }
            }
        });
    </script>
{% endblock %}
