{% extends "main.html" %}
{% block content %}
{% include "header.html" %}
{% raw %}
<main id="dashApp" style="height: 100%; padding-top:20px;" class="indexBackground ">
  <!-- IF NO USERINFO DISPLAY LOGIN-->
  <div v-if="!userInfo.name" class="padding20 card-panel red center-align">
    <h3 class="text_h3 white-text">
      You Must Be Signed In To Use Your Dashboard
    </h3>
    <a href="/oauth" class="btn green">
      Login
    </a>
  </div>
  <!-- IF USERINFO DISPLAY DASHBOARD -->
  <div v-if="userInfo.name" class="row" style="margin-bottom: 0; width: 100%;">
      <div class="col s12 m4 l3 xl3 transparent">
        <ul class="collection" style="border: none;">
          <li class="collection-item center-align transparent" >
            <img id="dashboardPhoto" width="70%" :src="userInfo.avatar_url" class="responsive-img hideOnSmall" alt="user image" style="box-shadow: 5px 5px 5px #273238; margin-bottom: -25px; border-radius: 10px; border: 2px white solid;">
          </li>
          <li class="collection-item center-align white-text padding20 blue" >
            <h5 class="text_h3 white-text textShadow swing-in-top-fwd">Hello, {{ userInfo.name.split(" ")[0] }}!</h5>
            <p><a target="_blank" class="white-text" :href="'https://github.com/'+userInfo.login"><i class="tiny fa fa-github-alt white-text"></i> {{userInfo.login}}</a></p>
          </li>
          <li class="collection-item blue-grey-text">
            <!-- <p>CONTRIBUTIONS<span class="chip secondary-content badge blue white-text">{{total}} APIs</span></p> -->
            <table class="table lighter" style="font-size: 1.5em;">
              <thead>
                <th class="center-align lighter">
                  CONTRIBUTIONS
                </th>
              </thead>
              <tbody>
                <tr class="swing-in-top-fwd">
                  <td class="blue-text center-align">
                    {{ total+" API's" }}
                  </td>
                </tr>
              </tbody>
            </table>
          </li>
          <li class="collection-item center-align">
            <a href="/logout" class="btn red smallFont">Log Out</a>
          </li>
        </ul>
      </div>
    <div class="col s12 m8 l9 xl9  center-align" >
        <!-- <h5 class="text_h3 white-text tracking-in-expand textShadow">MY DASHBOARD</h5> -->
        <div class="row">
          <div class="col s12">
            <ul class="tabs blue-grey">
              <li class="tab col s3 blue-grey darken-1">
                <a class="white-text textShadow " href="#contributions" style="font-size:10px;">
                  API List ({{total}})
                </a>
              </li>
              <li class="tab col s3 blue-grey darken-2">
                <a class="white-text textShadow" href="#extensions" style="font-size:10px;">
                  Extensions
                </a>
              </li>
              <li class="tab col s3 blue-grey darken-3">
                <a class="white-text textShadow" href="#about" style="font-size:10px;">
                  About
                </a>
              </li>
            </ul>
          </div>
          <div id="contributions" class="col s12 card-panel">
              <table id="dashboardTable" class="bordered" style="table-layout: fixed;">
                <thead>
                  <tr class="blue-grey-text">
                      <th class="lighter">API Name</th>
                      <!-- <th class="hideOnSmall">Description</th> -->
                      <th class="center-align lighter">Last Updated</th>
                      <th class="center-align lighter">Refresh</th>
                      <th class="center-align lighter">Delete</th>
                  </tr>
                </thead>
                <tbody>
                  <!-- For each API -->
                  <tr v-for="(api,index) in apis">
                    <td>
                       <a href="#modal2" class="modal-trigger smallFont" @click="getDetails(api.info, api._meta)">{{index+1 }}- <b>{{ api.info.title }}</b> <span class="grey-text smallFont">V.{{api.info.version}}</span> <i class="material-icons tiny blue-text">info_outline</i></a>
                    </td>
                    <!-- <td class="tableTextOverflow hideOnSmall" style="max-width: 100px; overflow: hidden;">
                      <p class="tableTextOverflow">{{ api.info.description }}</p>
                    </td> -->
                    <td class="center-align">
                      <span style="font-weight: bold" class="green-text smallFont">{{ convertDate(api._meta.timestamp) }}</span>
                    </td>
                    <td class="center-align">
                      <!-- <a @click="refreshingThis(api.info.title)" class="green btn" style="cursor: pointer;">
                        <i class=" material-icons white-text"  @mouseenter="$event.target.classList.add('rotate')" @mouseleave="$event.target.classList.remove('rotate')">refresh</i>
                      </a> -->
                      <!-- refresh button global component -->
                      <refresh :refresh='refreshingThis' :title='api.info.title'></refresh>
                    </td>
                    <td class="center-align">
                      <a href="#modal1" @click="deleteAPI(api.info.title, api._id)" class="btn scale-in-center red white-text modal-trigger" style="cursor: pointer;">
                        <i class="material-icons white-text">delete_forever</i>
                      </a>
                    </td>
                  </tr>
                  <!-- IF nor apis present -->
                  <tr v-if="apis.length === 0">
                    <td colspan="2"  class="center-align">
                      <span class="grey-text">No Contributions Yet</span><br>
                    </td>
                    <td colspan="2"  class="center-align">
                      <a class="btn red white-text" href="" @click="reloadAPIs()">Error? Reload APIs</a>
                    </td>
                  </tr>

                </tbody>
              </table>
          </div>
          <div id="extensions" class="col s12 card-panel ">
            <div class="card-panel white">
              <h3 class="text_h3 blue-text">SmartAPI Extensions</h3>
            <p>
                SmartAPI specific elements automatically generated from <a target="_blank" href="https://github.com/SmartAPI/smartAPI-Specification/blob/OpenAPI.next/versions/3.0.0.md">parent document</a>.
            </p>
            <p>
                Most of the SmartAPI extensions are optional, but a few are REQUIRED, for example:
                <br>
                <code>info.termOfService</code><br>
                <code>info.contact.x-role</code><br>
                <code>info.version</code><br>
                For a full list of REQUIRED extensions refer to the recommendations column of the document here:
            </p>
            <a class="btn blue" href="https://github.com/SmartAPI/smartAPI-Specification/blob/OpenAPI.next/versions/smartapi-list.md#fixed-fields-1" target="_blank">SmartAPI Extensions</a>
          </div>
          </div>
          <div id="about" class="col s12 card-panel center-align blue-text">
              <h2 class="text_h2">SmartAPI</h2>
              <i class="material-icons medium blue-text">info</i>
              <p>Version 1.2</p>
              <div class="card-panel">
                <h3 class="text_h3 blue-text">SmartAPI Links:</h3>
                <div class="row flexDad">
                  <div class="card-panel col s12 m6 l3 blue center-align flexKid">
                    <a href="https://github.com/SmartAPI/smartAPI" class="white-text">
                    <i class="material-icons medium white-text">folder</i>
                    <br>
                    SmartAPI Repository</a>
                  </div>
                  <div class="card-panel col s12 m6 l3 blue center-align flexKid">
                    <a href="https://github.com/SmartAPI/smartAPI-Specification" class="white-text">
                    <i class="material-icons medium white-text">extension</i>
                    <br>
                    SmartAPI Specification</a>
                  </div>
                  <div class="card-panel col s12 m6 l3 blue center-align flexKid">
                    <a href="smartAPI-editor" class="white-text">
                    <i class="material-icons medium white-text">edit</i>
                    <br>
                    SmartAPI Editor</a>
                  </div>
                  <div class="card-panel col s12 m6 l3 blue center-align flexKid">
                    <a href="https://github.com/SmartAPI/smartapi_registry" class="white-text">
                    <i class="material-icons medium white-text">dehaze</i>
                    <br>
                    SmartAPI Registry</a>
                  </div>
                </div>
            </div>
            <div class="card-panel">
              <h2 class="text_h2 blue-text">Contact</h2>
              <a href="mailto:" class="">
              <i class="material-icons medium blue-text">mail</i>
              <br>
              Email Us</a>
            </div>
          </div>
        </div>
    </div>
  </div>
  <!-- Modal for Deletion Confirmation -->
  <div id="modal1" class="modal center-align">
    <div class="modal-content">
      <h4 class="text_h3 blue-text">Delete <b>{{ confirmModal.title }}</b>?</h4>
      <div class="card-panel deep-orange accent-2">
        <i class="material-icons medium amber-text">warning</i>
        <p class="white-text">This action cannot be undone. Please type in the exact name of the API to confirm.</p>
        <input @change="getAPIName(confirmModal.title, $event)" :placeholder="confirmModal.title" type="text" class="validate browser-default" style="outline: none; padding: 10px; width: 70%;">
        <hr>
        <a href='#!' :disabled="confirmDelete" @click="deleteForever(confirmModal.title, confirmModal.id)" class="amber btn modal-action modal-close">Delete API</a>
      </div>
      <hr>
      <a href="#!" class="btn blue modal-action modal-close">Cancel</a>
    </div>
  </div>
  <!-- delete Modal end -->
  <!-- Details Modal -->
  <div id="modal2" class="modal center-align">
    <div class="modal-content">
      <ul class="collection with-header" style="border: none;">
        <li class="collection-header padding20">
          <h4 class="text_h3 blue-text">{{selectedAPI.title}}</h4>
          <span class="chip blue white-text smallFont" style="font-size: 12px; font-weight: bold;">Version {{ selectedAPI.version }}</span>
        </li>
        <li class="collection-item blue-grey lighten-4">
          <h4 class="blue-grey-text">{{ selectedAPIContact.name }}</h4>
          <h5 class="blue-grey-text lighter" style="text-transform: uppercase; font-size: 16px;">{{ selectedAPIContact["x-role"] }}</h5>
        </li>
        <li class="collection-item blue-grey lighten-5">
          <a :href="selectedAPIGithub" target="_blank"><i class="small fa fa-github-alt blue-text"></i> My Github</a>
        </li>
        <li class="collection-item padding20 blue-grey lighten-5">
          <fieldset class="padding20 white" style="border-radius: 10px; border: none;">
          <legend class="blue-text">Description:</legend>
            <p class="blue-grey-text">{{ selectedAPI.description }}</p>
          </fieldset>
        </li>
        <li class="collection-item blue-grey lighten-5">
          <i class="material-icons tiny blue-text">info_outline</i>
          <a :href="selectedAPI.termsOfService" target="_blank" class="blue-text">Terms of Service</a>
        </li>
      </ul>
      <a href="#!" class="btn blue modal-action modal-close">Close</a>
    </div>
  </div>
  <!-- details modal end -->
</main>




{% endraw %}
{% include "footer.html" %}
{% endblock %}

{% block extra_scripts %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/vue/2.4.2/vue.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/marked/0.3.6/marked.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/4.17.4/lodash.min.js"></script>

<script>

  // Refresh Button Component
  Vue.component('refresh', {
    data: function(){
      return{
        //timeout before being able to refresh again
        counter:30,
        //bind to disable attr while waiting
        currentlyRefreshing: false,
        text: 'refresh'
      }
    },
    // declare the props
    props: ['refresh', 'title'],
    // like data, the prop can be used inside templates and
    // is also made available in the vm as this.message
    methods:{
      countDown: function(){
        this.counter --;
        if( this.counter > 0 ){
          setTimeout(this.countDown,1000);
          this.currentlyRefreshing = true;
          this.text =this.counter+'...';
          var thisElement =$(this.$el);
          thisElement[0].text=this.text;
        }
        else if ( this.counter === 0){
          this.currentlyRefreshing = false;
          this.counter = 30;
          this.text = `<i class=" material-icons white-text"  @mouseenter="$event.target.classList.add('rotate')" @mouseleave="$event.target.classList.remove('rotate')">refresh</i>`;
          var thing =$(this.$el);
          thing[0].innerHTML=this.text;
        }
      },
      getText: function(){
        return this.text;
        console.log(this.text);
      }
    },
    mounted: function(){
      // mounted logic
    },
    template: `<a :disabled='currentlyRefreshing' @click="refresh(title); countDown()" :class="currentlyRefreshing ? 'btn grey' : 'green btn scale-in-center' " style="cursor: pointer; font-size:12px;">
                <i class=" material-icons white-text"  @mouseenter="$event.target.classList.add('rotate')" @mouseleave="$event.target.classList.remove('rotate')">refresh</i>
              </a>`
  })

  // Main Dashboard Component
    var app = new Vue({
        el: '#dashApp',
        data: function(){
          return {
            userInfo:{},
            confirmModal:{
              title:'',
              id:''
            },
            selectedAPI:{},
            selectedAPIContact: {},
            selectedAPIGithub:'',
            apis:[],
            total: 0,
            confirmDelete: true
          }
        },
        methods:{
          getApis: function(){
            var self=this;
            // production version
            // axios.get("http://smart-api.info/api/query?size=100&q=_meta.github_username:"+self.userInfo.login).then(function(response){
            //       //console.log(response.data.hits);
            //       self.apis = response.data.hits;
            //       self.total = response.data.total;
            //   }).catch(err=>{
            //     Materialize.toast('Failed To Load APIs', 4000,'rounded red white-text');
            //     throw err;
            //   });
              // testing version
            axios.get("/api/query?size=100&q=_meta.github_username:newgene").then(function(response){
                  //console.log(response.data.hits);
                  self.apis = response.data.hits;
                  self.total = response.data.total;
              }).catch(err=>{
                Materialize.toast('Failed To Load APIs', 4000,'rounded red white-text');
                throw err;
              });
          },
          deleteAPI: function(title, id){
            // api information sent to modal for confirmation to be deleted
            var self = this;
            self.confirmModal.title= title;
            self.confirmModal.id = id;
          },
          deleteForever: function(title, apiID){
            // ID for api to be deleted forever
            //console.log(id+' deleted TEST');

            // axios.delete('/api/metadata/', { data: { 'id': apiID } }).then(response=>{
            //   //sucessful deletion
            //   Materialize.toast(title+' was Deleted!', 4000,'rounded red white-text');
            // }).catch(error=>{
            //   //error deleting
            //   Materialize.toast(title+' was Deleted!', 4000,'rounded amber black-text');
            // });

            Materialize.toast(title+' was Deleted!', 4000,'rounded red white-text');
          },
          refreshingThis: function(title){
            var self = this;
            Materialize.toast(title+' was Refreshed!', 4000,'rounded green white-text');
            //Materialize.toast(title+' Failed To Refresh', 4000,'rounded red white-text');
          },
          getDetails: function(fullApiInfo, meta){
            var self = this;
            self.selectedAPI = fullApiInfo;
            self.selectedAPIContact = self.selectedAPI.contact;
            self.selectedAPIGithub = 'https://www.github.com/'+meta.github_username;
          },
          convertDate: function(timestamp){
            var date = new Date(timestamp);
            var formattedTime = date.getFullYear()+'-'
            + (date.getMonth()+1)
            + '-'+date.getDate()
            + ' @ '+date.getHours()
            + ':'+date.getMinutes();

            return formattedTime;
          },
          reloadAPIs: function(){
            this.getUserInfo();
          },
          getUserInfo: function(){
            var self= this;
            axios.get('/user').then(response=>{
              // console.log('user data');
              // console.log(response.data);
              self.userInfo = response.data;
              self.getApis();

            }).catch(err=>{
              throw err;
            })
          },
          getAPIName: function(APIToBeDeleted, event){
            // confirm API name to delete forever
            let input = event.target.value.trim();
            if(input === APIToBeDeleted){
              this.confirmDelete = false;
            }
            else{
              this.confirmDelete = true;
              Materialize.toast(input+' Does Not Match API Name', 4000,'rounded red white-text');
            }
          }
        },
        mounted: function(){
           // JQuery Initializations
           this.getUserInfo();
           // tabs
           $('ul.tabs').tabs();
           // modals
           $('.modal').modal({dismissible: true});
           // notifications
           $('.tooltipped').tooltip({delay: 50});

           $('.collapsible').collapsible();

        }
    });
</script>
{% endblock %}
